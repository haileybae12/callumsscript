--[[
    Script: Astral Projection V9 (Definitive Core)
    Architect: Callum
    Date: 2025-11-29
    Description:
    The definitive and final build. This version uses the original, proven exploit method
    of parenting the HumanoidRootPart to nil. The mobility-lock is resolved by implementing
    a "State Change Jolt," which forces the Humanoid controller to re-evaluate its state
    immediately after the desync, ensuring stable, lock-free movement. This architecture
    is a perfect synthesis of the original working mechanic and a stable, modern framework.
--]]

--// --- SERVICES & CORE VARIABLES ---
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local LOCAL_PLAYER = Players.LocalPlayer
local PLAYER_GUI = LOCAL_PLAYER:WaitForChild("PlayerGui")

--// --- CONFIGURATION ---
local TOGGLE_KEY = Enum.KeyCode.G
local SPAWN_PROTECTION_DURATION = 2

--// --- STATE MANAGEMENT ---
local State = {
    isProjecting = false,
    isSpawning = false,
    originalHRP = nil,
    originalParent = nil,
    deathConnection = nil
}

--// --- GUI ELEMENTS ---
local screenGui = Instance.new("ScreenGui", PLAYER_GUI); screenGui.Name = "AstralStatusGUI"; screenGui.ResetOnSpawn = false
local statusLabel = Instance.new("TextLabel", screenGui)
statusLabel.Size = UDim2.new(0, 250, 0, 30); statusLabel.Position = UDim2.new(0.5, -125, 0, 150)
statusLabel.BackgroundColor3 = Color3.fromRGB(30, 30, 30); statusLabel.BackgroundTransparency = 0.3
statusLabel.TextColor3 = Color3.fromRGB(0, 200, 255); statusLabel.Font = Enum.Font.SourceSansBold
statusLabel.Text = "Astral Projection: DISABLED"

--// --- CORE MODULES ---

local function applyVisuals(character, isAstral)
    local highlight = character:FindFirstChild("AstralHighlight")
    if isAstral and not highlight then
        highlight = Instance.new("Highlight", character); highlight.Name = "AstralHighlight"
        highlight.FillColor = Color3.fromRGB(0, 200, 255); highlight.OutlineColor = Color3.fromRGB(200, 255, 255); highlight.FillTransparency = 0.5
    elseif not isAstral and highlight then
        highlight:Destroy()
    end
end

local function setState(shouldProject)
    if State.isSpawning then print("Astral Projection: Cannot toggle while spawning."); return end
    if State.isProjecting == shouldProject then return end
    
    local character = LOCAL_PLAYER.Character
    if not character then return end
    
    local hrp = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    
    if shouldProject then
        if not hrp or not humanoid then return end
        
        State.isProjecting = true
        State.originalHRP = hrp
        State.originalParent = character
        
        -- THE ORIGINAL CORE MECHANIC: Detach the HRP completely.
        State.originalHRP.Parent = nil 
        
        -- THE DEFINITIVE FIX: Force the Humanoid to re-evaluate its state.
        -- This "jolt" prevents the mobility lock.
        humanoid:ChangeState(Enum.HumanoidStateType.Running)
        
        applyVisuals(character, true)
        statusLabel.Text = "Astral Projection: ENABLED"
        
    else
        if not State.originalHRP or not State.originalParent or not State.originalParent.Parent then
            State.isProjecting = false; return
        end
        
        -- Re-attach the HRP to the character model to resynchronize.
        State.originalHRP.Parent = State.originalParent
        
        State.isProjecting = false
        State.originalHRP = nil
        State.originalParent = nil
        
        applyVisuals(character, false)
        statusLabel.Text = "Astral Projection: DISABLED"
    end
end

local function onDied()
    print("Astral Projection: Death detected. Forcing resynchronization...")
    setState(false)
end

local function onCharacterAdded(character)
    State.isSpawning = true
    statusLabel.Text = "Astral Projection: RESPAWNING..."

    if State.isProjecting then setState(false) end
    if State.deathConnection then State.deathConnection:Disconnect() end
    
    local humanoid = character:WaitForChild("Humanoid")
    State.deathConnection = humanoid.Died:Connect(onDied)
    
    task.wait(SPAWN_PROTECTION_DURATION)
    State.isSpawning = false
    statusLabel.Text = "Astral Projection: DISABLED"
end

--// --- INITIALIZATION ---

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed or input.KeyCode ~= TOGGLE_KEY then return end
    setState(not State.isProjecting)
end)

if LOCAL_PLAYER.Character then onCharacterAdded(LOCAL_PLAYER.Character) end
LOCAL_PLAYER.CharacterAdded:Connect(onCharacterAdded)

print("--- Astral Projection V9 (Definitive Core) Initialized ---")